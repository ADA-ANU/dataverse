# Dataverse 6.2

Please note: To read these instructions in full, please go to https://github.com/IQSS/dataverse/releases/tag/v6.2 rather than the list of releases, which will cut them off.

This release brings new features, enhancements, and bug fixes to the Dataverse software.
Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.


## 💡Release highlights

### Return to Author Now Requires a Reason

The Popup for returning to author now requires a reason that will be sent by email to the author.

Please note that you can still type a creative and meaningful comment such as "The author would like to modify his dataset", "Files are missing", "Nothing to report" or "A curation report with comments and suggestions/instructions will follow in another email" that suits your situation.

### Support for Using Multiple PID Providers

This release adds support for using multiple PID (DOI, Handle, PermalLink) providers, multiple PID provider accounts
(managing a given protocol, authority,separator, shoulder combination), assigning PID provider accounts to specific collections,
and supporting transferred PIDs (where a PID is managed by an account when it's authority, separator, and/or shoulder don't match
the combination where the account can mint new PIDs). It also adds the ability for additional provider services beyond the existing
DataCite, EZId, Handle, and PermaLink providers to be dynamically added as separate jar files.

These changes require per-provider settings rather than the global PID settings previously supported. While backward compatibility 
for installations using a single PID Provider account is provided, updating to use the new microprofile settings is highly recommended
and will be required in a future version.

New microprofile settings (where * indicates a provider id indicating which provider the setting is for):

> - dataverse.pid.providers
> - dataverse.pid.default-provider
> - dataverse.pid.*.type
> - dataverse.pid.*.label
> - dataverse.pid.*.authority
> - dataverse.pid.*.shoulder
> - dataverse.pid.*.identifier-generation-style
> - dataverse.pid.*.datafile-pid-format
> - dataverse.pid.*.managed-list
> - dataverse.pid.*.excluded-list
> - dataverse.pid.*.datacite.mds-api-url
> - dataverse.pid.*.datacite.rest-api-url
> - dataverse.pid.*.datacite.username
> - dataverse.pid.*.datacite.password
> - dataverse.pid.*.ezid.api-url
> - dataverse.pid.*.ezid.username
> - dataverse.pid.*.ezid.password
> - dataverse.pid.*.permalink.base-url
> - dataverse.pid.*.permalink.separator
> - dataverse.pid.*.handlenet.index
> - dataverse.pid.*.handlenet.independent-service
> - dataverse.pid.*.handlenet.auth-handle
> - dataverse.pid.*.handlenet.key.path
> - dataverse.pid.*.handlenet.key.passphrase
> - dataverse.spi.pidproviders.directory

### Rate Limiting Using JCache (With Hazelcast As Provided by Payara)

The option to rate limit has been added to prevent users from over taxing the system either deliberately or by runaway automated processes.
Rate limiting can be configured on a tier level with tier 0 being reserved for guest users and tiers 1-any for authenticated users.
Superuser accounts are exempt from rate limiting.
Rate limits can be imposed on command APIs by configuring the tier, the command, and the hourly limit in the database.
Two database settings configure the rate limiting.
Note: If either of these settings exist in the database rate limiting will be enabled.
If neither setting exists rate limiting is disabled.

`:RateLimitingDefaultCapacityTiers` is a comma separated list of default values for each tier.
In the following example, the default for tier `0` (guest users) is set to 10,000 calls per command per hour and tier `1` (authenticated users) is set to 20,000 calls per command per hour.
Tiers not specified in this setting will default to `-1` (No Limit). I.e., -d "10000" is equivalent to -d "10000,-1,-1,..."

```
curl http://localhost:8080/api/admin/settings/:RateLimitingCapacityByTierAndAction -X PUT -d '[{
    "tier": 0,
    "limitPerHour": 10,
    "actions": [
        "GetLatestPublishedDatasetVersionCommand",
        "GetPrivateUrlCommand",
        "GetDatasetCommand",
        "GetLatestAccessibleDatasetVersionCommand"
    ]
},
{
    "tier": 0,
    "limitPerHour": 1,
    "actions": [
        "CreateGuestbookResponseCommand",
        "UpdateDatasetVersionCommand",
        "DestroyDatasetCommand",
        "DeleteDataFileCommand",
        "FinalizeDatasetPublicationCommand",
        "PublishDatasetCommand"
    ]
},
{
    "tier": 1,
    "limitPerHour": 30,
    "actions": [
        "CreateGuestbookResponseCommand",
        "GetLatestPublishedDatasetVersionCommand",
        "GetPrivateUrlCommand",
        "GetDatasetCommand",
        "GetLatestAccessibleDatasetVersionCommand",
        "UpdateDatasetVersionCommand",
        "DestroyDatasetCommand",
        "DeleteDataFileCommand",
        "FinalizeDatasetPublicationCommand",
        "PublishDatasetCommand"
    ]
}]'
```

Hazelcast is configured in Payara and should not need any changes for this feature

### Binder Redirect

If your installation is configured to use Binder, you should remove the old "girder_ythub" tool and replace it with the tool described at https://github.com/IQSS/dataverse-binder-redirect

For more information, see [#10360](https://github.com/IQSS/dataverse/issues/10360).

### Optional Croissant 🥐 Exporter Support

When a Dataverse installation is configured to use a metadata exporter for the [Croissant](https://github.com/mlcommons/croissant) format, the content of the JSON-LD in the **&lt;head>** of dataset landing pages will be replaced with that format. However, both JSON-LD and Croissant will still be available for download from the dataset page and API.

### Search by License

A new search facet called "License" has been added and will be displayed as long as there is more than one license in datasets and datafiles in browse/search results. This facet allow you to filter by license such as CC0, etc.

Also, the Search API now handles license filtering using the `fq` parameter, for example : `/api/search?q=*&fq=license%3A%22CC0+1.0%22` for CC0 1.0. 

For more information, see [#10204](https://github.com/IQSS/dataverse/issues/10204).

### Add .QPJ and .QMD Extensions to Shapefile Handling

- Support for **.qpj** and **.qmd** files in shapefile uploads has been introduced, ensuring that these files are properly recognized and handled as part of geospatial datasets in Dataverse.

### Ingested Tabular Data Files Can Be Stored Without the Variable Name Header

Tabular Data Ingest can now save the generated archival files with the list of variable names added as the first tab-delimited line. As the most significant effect of this feature.

Access API will be able to take advantage of Direct Download for tab. files saved with these headers on S3 - since they no longer have to be generated and added to the streamed content on the fly.

This behavior is controlled by the new setting **:StoreIngestedTabularFilesWithVarHeaders**. It is false by default, preserving the legacy behavior. When enabled, Dataverse will be able to handle both the newly ingested files, and any already-existing legacy files stored without these headers transparently to the user. E.g. the access API will continue delivering tab-delimited files **with** this header line, whether it needs to add it dynamically for the legacy files, or reading complete files directly from storage for the ones stored with it.

An API for converting existing legacy tabular files will be added separately. [this line will need to be changed if we have time to add said API before 6.2 is released]. [TODO]

### Uningest/Reingest Options Available in the File Page Edit Menu

New Uningest/Reingest options are available in the File Page Edit menu. Ingest errors can be cleared by users who can published the associated dataset and by superusers, allowing for a successful ingest to be undone or retried (e.g. after a Dataverse version update or if ingest size limits are changed).

The /api/files/<id>/uningest api also now allows users who can publish the dataset to undo an ingest failure.


## 🪲 Bugs

### Publication Status Facet Restored

In version 6.1, the publication status facet location was unintentionally moved to the bottom. In this version, we have restored the original order.

### Permissions Required To Assign a Role Have Been Fixed

The permissions required to assign a role have been fixed. It is no longer possible to assign a role that includes permissions that the assigning user doesn't have.

### Geospatial Metadata Block Fields for North and South Renamed

The Geospatial metadata block fields for north and south were labeled incorrectly as ‘Longitudes,’ as reported on #5645. After updating to this version of Dataverse, users will need to update all the endpoints that used ‘northLongitude’ and ‘southLongitude’ to ‘northLatitude’ and ‘southLatitude,’ respectively.

TODO: Whoever puts the release notes together should make sure there is the standard note about updating the schema after upgrading.

### OAI-PMH Error Handling Has Been Improved

OAI-PMH error handling has been improved to display a machine-readable error in XML rather than a 500 error with no further information.

> - /oai?foo=bar will show "No argument 'verb' found"
> - /oai?verb=foo&verb=bar will show "Verb must be singular, given: '[foo, bar]'"


## 💾 Persistence

### Missing Database Constraints

This release adds two missing database constraints that will assure that the externalvocabularyvalue table only has one entry for each uri and that the oaiset table only has one set for each spec. (In the very unlikely case that your existing database has duplicate entries now, install would fail. This can be checked by running

```
SELECT uri, count(*) FROM externalvocabularyvaluet group by uri;
```
and
```
SELECT spec, count(*) FROM oaiset group by spec;
```
and then removing any duplicate rows (where count>1).

TODO: Whoever puts the release notes together should make sure there is the standard note about reloading metadata blocks for the citation, astrophysics, and biomedical blocks (plus any others from other PRs) after upgrading.

### Universe Field in Variablemetadata Table Changed

Universe field in variablemetadata table was changed from **varchar(255)** to **text**. The change was made to support longer strings in "universe" metadata field, similar to the rest of text fields in variablemetadata table.

### Postgres Versions

This release adds install script support for the new permissions model in Postgres versions 15+, and bumps FlyWay to support Postgres 16.

Postgres 13 remains the version used with automated testing.


## 🌐 API 

### Listing Collection/Dataverse API

Listing collection/dataverse role assignments via API still requires ManageDataversePermissions, but listing dataset role assignments via API now requires only ManageDatasetPermissions.

### New API Endpoint for Clearing an Individual Dataset From Solr

A new Index API endpoint has been added allowing an admin to clear an individual dataset from Solr.

### New Accounts Metrics API

Users can retrieve new types of metrics related to user accounts. The new capabilities are [described](https://guides.dataverse.org/en/6.2/api/metrics.html) in the guides.

### New canDownloadAtLeastOneFile Endpoint

The `/api/datasets/{id}/versions/{versionId}/canDownloadAtLeastOneFile` endpoint has been created.

This API endpoint indicates if the calling user can download at least one file from a dataset version. Note that Shibboleth group permissions are not considered.

### Harvesting Client Endpoint Extended

The API endpoint `api/harvest/clients/{harvestingClientNickname}` has been extended to include the following fields:

- **allowHarvestingMissingCVV**: enable/disable allowing datasets to be harvested with Controlled Vocabulary Values that existed in the originating Dataverse Project but are not in the harvesting Dataverse Project. Default is false.

*Note: This setting is only available to the API and not currently accessible/settable via the UI*

### Version Files Endpoint Extended

The response for getVersionFiles `/api/datasets/{id}/versions/{versionId}/files` endpoint has been modified to include a total count of records available **totalCount:x**.
This will aid in pagination by allowing the caller to know how many pages can be iterated through. The existing API (getVersionFileCounts) to return the count will still be available.

### Metadata Blocks Endpoint Extended

The API endpoint `/api/metadatablocks/{block_id}` has been extended to include the following fields:

- **isRequired**: Whether or not this field is required
- **displayOrder**: The display order of the field in create/edit forms
- **typeClass**: The type class of this field ("controlledVocabulary", "compound", or "primitive")

### Get File Citation As JSON

It is now possible to retrieve via API the file citation as it appears on the file landing page. It is formatted in HTML and encoded in JSON.

This API is not for downloading various citation formats such as EndNote XML, RIS, or BibTeX. This functionality has been requested in [#3140](https://github.com/IQSS/dataverse/issues/3140) and [#9994](https://github.com/IQSS/dataverse/issues/9994)

### Files Endpoint Extended

The API endpoint `api/files/{id}` has been extended to support the following optional query parameters:

- **includeDeaccessioned**: Indicates whether or not to consider deaccessioned dataset versions in the latest file search. (Default: `false`).
- **returnDatasetVersion**: Indicates whether or not to include the dataset version of the file in the response. (Default: `false`).

A new endpoint `api/files/{id}/versions/{datasetVersionId}` has been created. This endpoint returns the file metadata present in the requested dataset version. To specify the dataset version, you can use `:latest-published`, `:latest`, `:draft` or `1.0` or any other available version identifier.

The endpoint supports the *includeDeaccessioned* and *returnDatasetVersion* optional query parameters, as does the `api/files/{id}` endpoint.

`api/files/{id}/draft` endpoint is no longer available in favor of the new endpoint `api/files/{id}/versions/{datasetVersionId}`, which can use the version identifier ``:draft`` (`api/files/{id}/versions/:draft`) to obtain the same result.

### Datasets, Dataverse Collections, and Datafiles Endpoints Extended

The API endpoints for getting datasets, Dataverse collections, and datafiles have been extended to support the following optional 'returnOwners' query parameter.

Including the parameter and setting it to true will add a hierarchy showing which dataset and dataverse collection(s) the object is part of to the json object returned. 

### Endpoint Fixed: Datasets Metadata

The API endpoint `api/datasets/{id}/metadata` has been changed to default to the latest version of the dataset that the user has access.


## 📖 Guides

### New QA Guide

A new QA Guide is intended mostly for the core development team but may be of interest to contributors.

### Container Guide, Documentation for Faster Redeploy

In the Container Guide, documentation for developers on how to quickly redeploy code has been added for Netbeans and improved for IntelliJ.

Also in the context of containers, a new option to skip deployment has been added and the war file is now consistently named "dataverse.war" rather than having a version in the filename, such as "dataverse-6.1.war". This predictability makes tooling easier.

Finally, an option to create tabs in the guides using [Sphinx Tabs](https://sphinx-tabs.readthedocs.io) has been added. (You can see the tabs in action in the "dev usage" page of the Container Guide.) To continue building the guides, you will need to install this new dependency by re-running  `pip install -r requirements.txt`.

### Evaluation Version Tutorial on the Containers Guide

The Container Guide now containers a tutorial for running Dataverse in containers for demo or evaluation purposes: https://guides.dataverse.org/en/6.2/container